---------------------------------------------------------------------------
Structured English: Send Speed and direction algorithm
---------------------------------------------------------------------------
Create message structure
Code element in mesage structure = 0xC0
first argument element in message structure = desired train number
least three bits of second argument element in message structure = speed
four following bits of second argument element in message structure = 0
last bit of second argument element in message structure = direction 
CALL psend function with message, size, and the DLL process mailbox address

---------------------------------------------------------------------------
Structured English: Send switch algorithm
---------------------------------------------------------------------------

Create message structure
Code element in mesage structure = 0xE0
first argument element in message structure = desired switch number
second argument element in message structure = direction of switch
CALL psend function with message, size, and the DLL process mailbox address


---------------------------------------------------------------------------
Structured English: Reset hall queue algorithm
---------------------------------------------------------------------------

Create message structure
Code element in mesage structure = 0xA8
first argument element in message structure = 0
second argument element in message structure = 0
CALL psend function with message, size, and the DLL process mailbox address

---------------------------------------------------------------------------
Structured English: hall sensor acknowledgment
---------------------------------------------------------------------------

Create message structure
Code element in mesage structure = 0xC0
first argument element in message structure = hall sensor number
second argument element in message structure = 0
CALL psend function with message, size, and the DLL process mailbox address

---------------------------------------------------------------------------
Structured English: Data link layer (DDL) process algorithm
---------------------------------------------------------------------------



---------------------------------------------------------------------------
Structured English: kterm
---------------------------------------------------------------------------

store the running process's PCB
remove the running process from the WTR queue
set the running process to the next one in the list
free the stored process's stack
free the stored process's PCB
set the PSP to the current running process's SP
restore the registers of the current running process

---------------------------------------------------------------------------
Structured English: pgetid
---------------------------------------------------------------------------

CALL pkcall subroutine with GETID code message
provide the id number to the calling process 
EXIT 

---------------------------------------------------------------------------
Structured English: kgetid
---------------------------------------------------------------------------

provide the id number of the running process to the calling routine
EXIT

---------------------------------------------------------------------------
Structured English: pnice
---------------------------------------------------------------------------
IF desired priority is higher than 1 OR lower than 3
	THEN CALL pkcall routine with NICE code message and desired priority
	EXIT
ELSE
	EXIT with ERROR code
ENDIF



---------------------------------------------------------------------------
Structured English: knice
---------------------------------------------------------------------------
Set SP of the running process to the PSP
change priority of running process to desired prioirty
IF desired priority = current priority
	THEN EXIT
ELSE
	remove running PCB from current WTR queue 
	insert running PCB into new priority queue
ENDIF
IF desired priority > current priority
	THEN set current priority = desired priority
ENDIF
Set the PSP to the SP of the  current running process	
EXIT

---------------------------------------------------------------------------
Structured English: pbind
---------------------------------------------------------------------------

IF mailbox number is within boundary 
	THEN CALL pkcall routine with BIND code message and mailbox number 
	EXIT with mailbox number
ELSE 
	EXIT with error message
ENDIF

---------------------------------------------------------------------------
Structured English: kbind
---------------------------------------------------------------------------

IF Process is already bound to mailbox OR mailbox is bound to another process
	THEN EXIT with error code
ELSE
	store desired mailbox ID in PCB
	connect PCB to desired mailbox
	EXIT with mailbox number
ENDIF

---------------------------------------------------------------------------
Structured English: psend
---------------------------------------------------------------------------

IF size of message to be sent > max message size
	THEN EXIT with error code
ENDIF
create message request with destination mailbox id, message, and its size
CALL pkcall routine with SEND code and message request 
EXIT

---------------------------------------------------------------------------
Structured English: ksend
---------------------------------------------------------------------------

IF sender does not own a mailbox OR destination mailbox not found
	THEN EXIT with error code
ENDIF
IF receiving process is blocked
	THEN give message, its size, and source id directly to receiver
	Unblock receiver by inserting its PCB into WTR queue
ELSE
	put message, its size, and source id into the receive mailbox
ENDIF
EXIT with success code

---------------------------------------------------------------------------
Structured English: precv
---------------------------------------------------------------------------

create mcb with buffer and buffer size
CALL pkcall routine with RECV code messsage and an mcb to store msg
EXIT with number of bytes sent and sender id.

---------------------------------------------------------------------------
Structured English: krecv
---------------------------------------------------------------------------

IF the current process is not bound to a mailbox 
	
	THEN EXIT with error code
ELSE
	IF a message is found in the mailbox
		
		THEN EXIT with message back to precv routine
	
	ELSE
		
		store address of process mcb in mailbox
	
		Store current psp to pcb's sp
		
		block running process by removing it from WTR queue
		
		change current psp to next pcb's sp
		

---------------------------------------------------------------------------
Structured English: p_uart
---------------------------------------------------------------------------
Set

EXIT

---------------------------------------------------------------------------
Structured English: k_uart
---------------------------------------------------------------------------
Set

EXIT

---------------------------------------------------------------------------
Structured English: time server
---------------------------------------------------------------------------

Receive a message from the mailbox
IF the message is from SYSTICK
	THEN increment the global counter
	IF counter of first entry in the UART list = global counter
		THEN send a wake up message to the process
		remove the entry from the sleeping list		
	ENDIF
ELSE
	IF the message is a time request
		THEN send the global counter to the mailbox of the requesting process
	ELSE
		extract the mailbox id and the sleeping duration from the received message
		create a sleeping process entry
		set counter element in sleeping process entry = requested time + global counter
		set the mailbox id element = mailbox id of the sleeping process
		enqueue the entry in the sleep list and place it according to counter value
	ENDIF
ENDIF   
REPEAT

---------------------------------------------------------------------------
Structured English: window manager
---------------------------------------------------------------------------
Set

EXIT

---------------------------------------------------------------------------
Structured English: idle process
---------------------------------------------------------------------------
Set

EXIT